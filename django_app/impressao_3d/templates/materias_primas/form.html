{% extends "base.html" %}

{% block title %}
{% if materia %}Editar{% else %}Nova{% endif %} Matéria-prima
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1 class="mb-4">{% if materia %}Editar{% else %}Nova{% endif %} Matéria-prima</h1>

  <form method="POST">
    {% csrf_token %}

    <!-- Nome -->
    <div class="mb-3">
      <label for="{{ form.nome.id_for_label }}" class="form-label">{{ form.nome.label }}</label>
      {{ form.nome }}
    </div>

    <!-- Tipo -->
    <div class="mb-3">
      <label for="{{ form.tipo.id_for_label }}" class="form-label">{{ form.tipo.label }}</label>
      {{ form.tipo }}
    </div>

    <!-- Material -->
    <div class="mb-3">
      <label for="{{ form.material.id_for_label }}" class="form-label">{{ form.material.label }}</label>
      {{ form.material }}
    </div>

    <!-- Cor -->
    <div class="mb-3">
      <label for="{{ form.cor.id_for_label }}" class="form-label">{{ form.cor.label }}</label>
      {{ form.cor }}
    </div>

    <!-- Marca + botão ao lado -->
    <div class="mb-3">
      <label for="{{ form.marca.id_for_label }}" class="form-label">{{ form.marca.label }}</label>
      <div class="input-group">
        {{ form.marca }}
        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalNovaMarca">
          + Nova Marca
        </button>
      </div>
    </div>

    <!-- Quantidade -->
    <div class="mb-3">
      <label for="{{ form.quantidade.id_for_label }}" class="form-label">{{ form.quantidade.label }}</label>
      {{ form.quantidade }}
    </div>

    <!-- Estoque mínimo -->
    <div class="mb-3">
      <label for="{{ form.estoque_minimo.id_for_label }}" class="form-label">{{ form.estoque_minimo.label }}</label>
      {{ form.estoque_minimo }}
    </div>

    <!-- Preço total -->
    <div class="mb-3">
      <label for="{{ form.preco_total.id_for_label }}" class="form-label">{{ form.preco_total.label }}</label>
      {{ form.preco_total }}
    </div>

    <!-- Unidade -->
    <div class="mb-3">
      <label for="{{ form.unidade.id_for_label }}" class="form-label">{{ form.unidade.label }}</label>
      {{ form.unidade }}
    </div>
    <div class="mt-4">
      <button type="submit" class="btn btn-success">Salvar</button>
      <a href="{% url 'estoque:lista_materias_primas' %}" class="btn btn-secondary">← Voltar</a>
    </div>
  </form>

    <!-- Modal Nova Marca -->
    <div class="modal fade" id="modalNovaMarca" tabindex="-1" aria-labelledby="modalNovaMarcaLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalNovaMarcaLabel">Adicionar Nova Marca</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="text" id="nova_marca_nome" class="form-control" placeholder="Nome da marca" required>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" id="salvarMarcaBtn" class="btn btn-primary">Salvar Marca</button>
          </div>
        </div>
      </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const btn = document.getElementById("salvarMarcaBtn");
  const input = document.getElementById("nova_marca_nome");
  const modalEl = document.getElementById("modalNovaMarca");

  if (!btn) {
    console.error("Botão salvarMarcaBtn não encontrado no DOM.");
    return;
  }

  btn.addEventListener("click", async function () {
    const nome = input.value.trim();
    if (!nome) {
      alert("Informe o nome da marca.");
      return;
    }

    const csrfInput = document.querySelector('input[name=csrfmiddlewaretoken]');
    const csrf = csrfInput ? csrfInput.value : '';

    try {
      const res = await fetch("{% url 'estoque:criar_marca_ajax' %}", {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrf,
        },
        body: JSON.stringify({ nome })
      });
      const data = await res.json();

      if (data.success) {
        const select = document.getElementById("id_marca");
        if (select) {
          const opt = new Option(data.nome, data.id, true, true);
          select.add(opt);
        }
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();
        input.value = "";
      } else {
        alert("Erro: " + (data.error || "Não foi possível salvar a marca."));
      }
    } catch (err) {
      console.error(err);
      alert("Falha na requisição AJAX.");
    }
  });
});
</script>
{% endblock %}
